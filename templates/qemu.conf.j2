# qemu config file

[drive]
  file = "/dev/zvol/{{ kvm_zfs_filesystem }}/{{ kvm_machine.name }}/disk"
  if = "{{ kvm_machine_drive_if }}"
  format = "raw"

{% for drive in kvm_machine.disks|default([]) %}
[drive]
  file = "/dev/zvol/{{ kvm_zfs_filesystem }}/{{ kvm_machine.name }}/disk_{{ drive.name }}"
  if = "{{ kvm_machine_drive_if }}"
  format = "raw"

{% endfor %}
[drive]
  if = "floppy"
  index = "0"
  file = "/dev/zvol/{{ kvm_zfs_filesystem }}/{{ kvm_machine.name }}/kickoff"
  format = "raw"

{% for filesystem in kvm_machine.filesystems|default([]) %}
[fsdev "{{ filesystem.name }}"]
  fsdriver = "local"
  path = "{{ kvm_image_root }}/{{ kvm_machine.name }}/fs_{{ filesystem.name }}/"
  security_model = "mapped"
  readonly = "{{ filesystem.readonly|default('off') }}"

[device]
  driver = "virtio-9p-pci"
  fsdev = "{{ filesystem.name }}"
  mount_tag = "{{ filesystem.name }}"

{% endfor %}
[chardev "mon0"]
  backend = "socket"
  server = "on"
  path = "/tmp/{{ kvm_machine.name }}-kvm/{{ kvm_machine.name }}.monitor.S"
  wait = "off"

{% for bridge in kvm_machine.bridge %}
{% set macbase=[bridge.guest, kvm_machine.name]|join('@')|checksum %}
[device]
  driver = "virtio-net-pci"
  netdev = "{{ bridge.guest }}"
  addr = "{{ '%x'|format(bridge.guest|regex_replace('^e..','')|int) }}"
  mac = "{{ bridge.mac|default(['52', '54', '00', macbase[0:2], macbase[2:4], macbase[4:6]]|join(':')) }}"

[netdev "{{ bridge.guest }}"]
  type = "bridge"
  br = "{{ bridge.host }}"

{% endfor %}
[mon]
  chardev = "mon0"
  mode = "readline"

[machine]
  accel = "{{ kvm_machine_accel_cur }}"
  firmware = "{{ kvm_firmware_root }}/{{ kvm_machine_firmware_type }}.firmware"
{% if kvm_machine_graphics == False %}  graphics = "off"{% endif %}
{% if 'usb_host' in kvm_machine %}  usb = "on"{% endif %}

{% if kvm_machine_graphics == True %}
[device]
  driver = "{{ kvm_machine.graphics_driver|default('qxl-vga') }}"
  ram_size = "{{ kvm_machine.graphics_ram_size|default('2048000') }}"
  xres = "{{ kvm_machine.graphics_xres|default('1920') }}"
  yres = "{{ kvm_machine.graphics_xres|default('1080') }}"

{% endif %}
{% for usb_host in kvm_machine.usb_host %}
[device]
  driver = "usb-host"
{% for k in usb_host.keys() %}
  {{ k }} = "{{ usb_host[k] }}"
{% endfor %}

{% endfor %}
[memory]
  size = "{{ kvm_machine.memory|default('1024') }}"

[smp-opts]
  cpus = "{{ kvm_machine.cpu|default(1) }}"

{% if kvm_monitor == "vnc" %}
[vnc "default"]
  vnc = "unix:/tmp/{{ kvm_machine.name }}-kvm/{{ kvm_machine.name }}.vnc.S"

{% else %}
[chardev "vdagent"]
  backend = "spicevmc"
  debug = "0"
  name = "vdagent"

[device]
  driver = "virtio-serial"

[device]
  driver = "virtserialport"
  chardev = "vdagent"
  name = "com.redhat.spice.0"

[spice]
  addr = "{{ kvm_machine_spice_addr }}"
{% if kvm_machine_spice_disable_ticketing == False %}  password = "{{ kvm_machine_spice_password }}"{% endif %}
{% if kvm_machine_spice_unix == True %}  unix = "on"{% endif %}
{% if kvm_machine_spice_unix == False %}  port = "{{ kvm_machine_spice_port }}"{% endif %}
{% if kvm_machine_spice_disable_ticketing == True %}  disable-ticketing = "on"{% endif %}
{% if kvm_machine_spice_disable_agent_file_xfer == True %}  disable-agent-file-xfer = "on"{% endif %}
{% if kvm_machine_spice_disable_copy_paste == True %}  disable-copy-paste = "on"{% endif %}

{% endif %}
